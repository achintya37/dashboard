<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIKARKHANJI JNYCTSD - Admin Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --primary: #2563eb; --secondary: #1e40af; 
            --bg: #f3f4f6; --white: #ffffff; --text: #1f2937; 
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; 
            --purple: #8b5cf6; --pink: #ec4899;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); display: flex; height: 100vh; overflow: hidden; }

        /* Login Screen */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { text-align: center; padding: 40px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); background: #fff; width: 90%; max-width: 400px; }
        .google-btn { background: #4285F4; color: white; border: none; padding: 12px 25px; border-radius: 50px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; margin: 20px auto; box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3); transition: transform 0.2s; }
        .google-btn:active { transform: scale(0.95); }

        /* Sidebar */
        .sidebar { width: 280px; background: #fff; padding: 25px; display: flex; flex-direction: column; box-shadow: 4px 0 20px rgba(0,0,0,0.02); z-index: 100; border-right: 1px solid #e5e7eb; }
        .brand { margin-bottom: 40px; border-bottom: 2px solid #f3f4f6; padding-bottom: 20px; }
        .brand h1 { font-size: 1.4rem; font-weight: 800; color: var(--primary); line-height: 1.2; letter-spacing: -0.5px; }
        .brand p { font-size: 0.75rem; font-weight: 600; color: #9ca3af; margin-top: 5px; letter-spacing: 1px; }
        
        .nav-item { padding: 14px 18px; margin-bottom: 8px; border-radius: 12px; color: #6b7280; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 14px; transition: all 0.2s ease; }
        .nav-item:hover { background: #eff6ff; color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); }

        /* Main Content */
        .main { flex: 1; padding: 30px; overflow-y: auto; height: 100vh; padding-bottom: 120px; display: none; }
        .section { display: none; animation: fadeIn 0.4s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Advanced Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 16px; position: relative; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #f3f4f6; }
        .stat-icon { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; opacity: 0.2; }
        .stat-label { font-size: 0.85rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: var(--text); margin-top: 5px; }
        .stat-sub { font-size: 0.8rem; margin-top: 5px; font-weight: 500; }

        /* Color Borders for Cards */
        .card-blue { border-left: 5px solid var(--primary); }
        .card-green { border-left: 5px solid var(--success); }
        .card-red { border-left: 5px solid var(--danger); }
        .card-purple { border-left: 5px solid var(--purple); }
        .card-pink { border-left: 5px solid var(--pink); }

        /* Form & Tables */
        .content-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 25px; border: 1px solid #f3f4f6; }
        .input-box, select { width: 100%; padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; outline: none; background: #fff; font-size: 0.95rem; transition: border-color 0.2s; }
        .input-box:focus { border-color: var(--primary); }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; background: var(--primary); font-size: 1rem; transition: transform 0.1s; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .btn:active { transform: scale(0.98); }

        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: #f9fafb; padding: 15px; text-align: left; font-size: 0.8rem; font-weight: 700; color: #6b7280; text-transform: uppercase; border-bottom: 2px solid #e5e7eb; }
        td { padding: 15px; border-bottom: 1px solid #f3f4f6; font-size: 0.95rem; color: #374151; vertical-align: middle; }
        tr:hover { background: #f9fafb; }

        /* Buttons & Badges */
        .action-btn { width: 36px; height: 36px; border-radius: 8px; border: none; color: white; cursor: pointer; margin-right: 6px; display: inline-flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-pay { background: var(--success); }
        .btn-drop { background: #64748b; } /* Grey for dropout */
        .btn-del { background: var(--danger); }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
        
        /* Modal */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:200; justify-content:center; align-items:center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; flex-direction: row; justify-content: space-around; padding: 5px; border-top: 1px solid #e5e7eb; border-right: none; }
            .brand { display: none; }
            .nav-item { flex-direction: column; gap: 2px; font-size: 0.65rem; padding: 8px; margin: 0; border-radius: 8px; background: transparent !important; color: #9ca3af; box-shadow: none !important;}
            .nav-item.active { color: var(--primary); }
            .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }
            .main { padding: 15px; padding-bottom: 100px; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-bottom: 10px;">TIKARKHANJI JNYCTSD</h2>
            <p style="color: #6b7280; font-size: 0.9rem;">Admin Panel Login</p>
            <button class="google-btn" onclick="googleLogin()">
                <i class="fab fa-google"></i> Login with Google
            </button>
            <div class="loader" id="loader"></div>
            <p id="login-status" style="margin-top: 15px; color: red; font-size: 0.8rem;"></p>
        </div>
    </div>

    <div class="sidebar" id="sidebar" style="display: none;">
        <div class="brand"><h1>TIKARKHANJI<br>JNYCTSD</h1><p>MANAGEMENT PRO</p></div>
        <div class="nav-item active" id="btn-dash" onclick="navigate('dashboard')"><i class="fas fa-th-large"></i><span>Dashboard</span></div>
        <div class="nav-item" id="btn-adm" onclick="navigate('admission')"><i class="fas fa-user-plus"></i><span>Admission</span></div>
        <div class="nav-item" id="btn-std" onclick="navigate('students')"><i class="fas fa-users"></i><span>Students</span></div>
        <div class="nav-item" id="btn-exp" onclick="navigate('expenses')"><i class="fas fa-wallet"></i><span>Expenses</span></div> <div class="nav-item" style="margin-top: auto; color: var(--danger);" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></div>
    </div>

    <div class="main" id="main-content">
        
        <div id="dashboard" class="section active">
            <h2 style="margin-bottom:20px; color:#111827;">ðŸ“Š Overview</h2>
            
            <div class="stats-grid">
                <div class="stat-card card-blue">
                    <i class="fas fa-user-graduate stat-icon"></i>
                    <div class="stat-label">Active Students</div>
                    <div class="stat-val" id="d_active">0</div>
                    <div class="stat-sub" style="color:var(--danger)">Dropouts: <span id="d_dropout">0</span></div>
                </div>

                <div class="stat-card card-green">
                    <i class="fas fa-rupee-sign stat-icon"></i>
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-val" style="color:var(--success)" id="d_collected">â‚¹0</div>
                    <div class="stat-sub">Lifetime Collection</div>
                </div>

                <div class="stat-card card-red">
                    <i class="fas fa-exclamation-circle stat-icon"></i>
                    <div class="stat-label">Market Due</div>
                    <div class="stat-val" style="color:var(--danger)" id="d_due">â‚¹0</div>
                    <div class="stat-sub">From Active Students</div>
                </div>

                <div class="stat-card card-purple">
                    <i class="fas fa-chart-line stat-icon"></i>
                    <div class="stat-label">Projected Revenue</div>
                    <div class="stat-val" style="color:var(--purple)" id="d_projected">â‚¹0</div>
                    <div class="stat-sub">If all active pay full</div>
                </div>

                <div class="stat-card card-pink">
                    <i class="fas fa-file-invoice-dollar stat-icon"></i>
                    <div class="stat-label">Total Expenses</div>
                    <div class="stat-val" style="color:var(--pink)" id="d_expense">â‚¹0</div>
                    <div class="stat-sub">Salaries, Bills, Rent</div>
                </div>

                <div class="stat-card" style="border-left: 5px solid #000;">
                    <i class="fas fa-wallet stat-icon"></i>
                    <div class="stat-label">Net Profit</div>
                    <div class="stat-val" id="d_profit">â‚¹0</div>
                    <div class="stat-sub">Revenue - Expenses</div>
                </div>
            </div>
        </div>

        <div id="admission" class="section">
            <h2 style="margin-bottom:20px">ðŸ‘¤ New Admission</h2>
            <div class="content-card">
                <form id="admForm">
                    <div style="background:#f0f9ff; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #dbeafe;">
                        <label style="font-weight:600; display:block; margin-bottom:8px;">Student Type</label>
                        <select id="studentType" onchange="setDefaults()" class="input-box" style="margin-bottom:10px;">
                            <option value="junior">Junior Student (Class 9 & Below)</option>
                            <option value="senior">Senior Student (Course Based)</option>
                        </select>
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                            <input type="checkbox" id="isOldStudent" onchange="toggleOldStudent()" style="width:18px; height:18px;">
                            Old Student (Waive Admission Fee)
                        </label>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <input type="text" id="name" required class="input-box" placeholder="Full Name">
                        <input type="text" id="batch" required class="input-box" placeholder="Batch Name">
                    </div>
                    <input type="number" id="phone" required class="input-box" placeholder="Mobile Number">
                    <label style="font-size:0.85rem; font-weight:600;">Joining Date</label>
                    <input type="date" id="joinDate" required class="input-box">
                    
                    <div style="background:#f9fafb; padding:15px; border-radius:10px; margin-top:10px;">
                        <h4 style="margin-bottom:10px; color:#6b7280;">Fee Structure</h4>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <input type="number" id="admFee" class="input-box" placeholder="Adm Fee">
                            <input type="number" id="monthlyFee" class="input-box" placeholder="Monthly Fee">
                            <input type="number" id="examFee" class="input-box" placeholder="Exam Fee">
                            <input type="number" id="duration" class="input-box" placeholder="Months">
                        </div>
                    </div>
                    <button type="submit" class="btn">Confirm Admission</button>
                </form>
            </div>
        </div>

        <div id="students" class="section">
            <h2 style="margin-bottom:20px">ðŸ“‹ Student Management</h2>
            <div class="content-card">
                <input type="text" id="search" placeholder="ðŸ” Search active students..." onkeyup="renderTable()" class="input-box">
                <div style="overflow-x:auto">
                    <table id="table">
                        <thead>
                            <tr>
                                <th>Student Info</th>
                                <th>Fees Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="expenses" class="section">
            <h2 style="margin-bottom:20px">ðŸ’¸ Expense Manager</h2>
            
            <div class="content-card">
                <form id="expForm">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <select id="expCat" class="input-box">
                            <option>Salary</option>
                            <option>Electricity Bill</option>
                            <option>Broadband</option>
                            <option>Computer Repair</option>
                            <option>Room Rent</option>
                            <option>Others</option>
                        </select>
                        <input type="number" id="expAmount" required class="input-box" placeholder="Amount (â‚¹)">
                    </div>
                    <input type="text" id="expNote" class="input-box" placeholder="Description (Optional)">
                    <input type="date" id="expDate" required class="input-box">
                    <button type="submit" class="btn" style="background:var(--pink)">Add Expense</button>
                </form>
            </div>

            <div class="content-card">
                <h3 style="margin-bottom:15px;">Expense History</h3>
                <div style="overflow-x:auto">
                    <table id="expTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category & Note</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="expBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3>ðŸ’° Receive Payment</h3><br>
            <select id="payType" class="input-box">
                <option>Monthly Fee</option>
                <option>Admission Fee</option>
                <option>Exam Fee</option>
            </select>
            <input type="number" id="payAmount" class="input-box" placeholder="Amount">
            <button onclick="submitPay()" class="btn">Confirm & Receipt</button>
            <button onclick="document.getElementById('modal').style.display='none'" class="btn" style="background:#e5e7eb; color:#374151; margin-top:10px;">Close</button>
        </div>
    </div>

<script>
    // ðŸ”¥ CONFIG ðŸ”¥
    const firebaseConfig = {
        apiKey: "AIzaSyCUmRYc8WtQP3LW_85i5Czore9YjWw0yLU",
        authDomain: "tikarkhanjijnyctsd.firebaseapp.com",
        databaseURL: "https://tikarkhanjijnyctsd-default-rtdb.firebaseio.com",
        projectId: "tikarkhanjijnyctsd",
        storageBucket: "tikarkhanjijnyctsd.appspot.com",
        messagingSenderId: "513267646081",
        appId: "1:513267646081:web:1b60262e26e5e6dcef9780"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const ADMIN_EMAIL = "achintyaghosh37@gmail.com"; 

    // STATE
    let students = [];
    let expenses = [];
    let currentId = null;

    // --- AUTH ---
    function googleLogin() {
        document.getElementById('loader').style.display = 'block';
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(err => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('login-status').innerText = err.message;
        });
    }

    function logout() { auth.signOut(); location.reload(); }

    auth.onAuthStateChanged(user => {
        document.getElementById('loader').style.display = 'none';
        if (user && user.email === ADMIN_EMAIL) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('main-content').style.display = 'block';
            loadData();
        } else if (user) {
            auth.signOut();
            alert("Access Denied!");
        } else {
            document.getElementById('login-overlay').style.display = 'flex';
        }
    });

    // --- DATA LOADING (FIXED) ---
    function loadData() {
        // Load Students
        db.ref('students').on('value', (snapshot) => {
            const data = snapshot.val();
            students = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
            // Safe repair
            students.forEach(s => {
                if (!s.payments) s.payments = [];
                s.status = s.status || 'active'; // active or dropout
            });
            updateDashboard();
            renderTable();
        });

        // Load Expenses
        db.ref('expenses').on('value', (snapshot) => {
            const data = snapshot.val();
            expenses = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
            updateDashboard();
            renderExpenses();
        });
    }

    // --- ADMISSION LOGIC ---
function setDefaults() {
        const type = document.getElementById('studentType').value;
        const isOld = document.getElementById('isOldStudent').checked;
        const adm = document.getElementById('admFee');
        
        if(type === 'senior') {
            adm.value = isOld ? 0 : 400;
            document.getElementById('monthlyFee').value = 300;
            document.getElementById('examFee').value = 500;
            document.getElementById('duration').value = 12;
        } else {
            adm.value = isOld ? 0 : 500;
            document.getElementById('monthlyFee').value = 250;
            document.getElementById('examFee').value = 0;
            document.getElementById('duration').value = 12;
        }
        adm.disabled = isOld;
    }
    
    function toggleOldStudent() { setDefaults(); }

    document.getElementById('admForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const s = {
            status: 'active',
            type: document.getElementById('studentType').value,
            name: document.getElementById('name').value,
            batch: document.getElementById('batch').value,
            phone: document.getElementById('phone').value,
            joinDate: document.getElementById('joinDate').value,
            admFee: Number(document.getElementById('admFee').value),
            monthlyFee: Number(document.getElementById('monthlyFee').value),
            duration: Number(document.getElementById('duration').value),
            examFee: Number(document.getElementById('examFee').value),
            payments: []
        };
        db.ref('students').push(s);
        e.target.reset();
        setDefaults();
        alert("Student Added Successfully!");
        navigate('students');
    });

    // --- DROPOUT LOGIC ---
    function markDropout(id) {
        if(confirm("Mark this student as Drop-Out?\nTheir dues will stop, but payment history remains.")) {
            db.ref('students/' + id).update({ status: 'dropout' });
        }
    }

    // --- EXPENSE LOGIC ---
    document.getElementById('expForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const ex = {
            category: document.getElementById('expCat').value,
            amount: Number(document.getElementById('expAmount').value),
            note: document.getElementById('expNote').value,
            date: document.getElementById('expDate').value
        };
        db.ref('expenses').push(ex);
        document.getElementById('expAmount').value = '';
        document.getElementById('expNote').value = '';
        alert("Expense Added!");
    });

    function deleteExpense(id) {
        if(confirm("Remove this expense entry?")) db.ref('expenses/' + id).remove();
    }

    function renderExpenses() {
        const tbody = document.getElementById('expBody');
        tbody.innerHTML = '';
        expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(ex => {
            tbody.innerHTML += `
                <tr>
                    <td>${ex.date}</td>
                    <td><b>${ex.category}</b><br><small>${ex.note}</small></td>
                    <td style="color:var(--danger); font-weight:bold;">- â‚¹${ex.amount}</td>
                    <td><button class="action-btn btn-del" onclick="deleteExpense('${ex.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>`;
        });
    }

    // --- FINANCIAL CALCULATIONS (FIXED) ---
    function getFinance(s) {
        let paid = 0;
        s.payments.forEach(p => paid += p.amount);

        // If dropout, Due is 0 (or strictly what was due before drop, but simplified to 0 here to clean lists)
        // Ideally, Total Fee = what they agreed to pay.
        // For Active:
        let totalProjected = s.admFee + s.examFee + (s.monthlyFee * s.duration);
        
        // Calculate current due based on time passed
        const start = new Date(s.joinDate);
        const now = new Date();
        let months = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth()) + 1;
        if (months < 1) months = 1;
        if (months > s.duration) months = s.duration; // Cap at course duration

        let currentPayable = s.admFee + s.examFee + (s.monthlyFee * months);
        let currentDue = Math.max(0, currentPayable - paid);

        if(s.status === 'dropout') {
            currentDue = 0; // Dropouts have no pending market due
            totalProjected = paid; // Revenue stops at what they paid
        }

        return { paid, currentDue, totalProjected };
    }

    // --- RENDER STUDENTS ---
    function renderTable() {
        const tbody = document.getElementById('tbody');
        const search = document.getElementById('search').value.toLowerCase();
        tbody.innerHTML = '';

        // Filter only ACTIVE students for the main list (or search all)
        const activeStudents = students.filter(s => s.status !== 'dropout');
        
        if(activeStudents.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:20px;">No active students found.</td></tr>`;
            return;
        }

        activeStudents.filter(s => s.name.toLowerCase().includes(search)).reverse().forEach(s => {
            const f = getFinance(s);
            const badge = s.type==='senior' 
                ? `<span class="badge" style="background:#f3e8ff; color:#7c3aed;">Senior</span>` 
                : `<span class="badge" style="background:#e0f2fe; color:#0284c7;">Junior</span>`;

            tbody.innerHTML += `
                <tr>
                    <td>
                        <b>${s.name}</b> ${badge}<br>
                        <small style="color:#6b7280">${s.batch}</small>
                    </td>
                    <td>
                        <div style="font-weight:700; color:${f.currentDue > 0 ? 'var(--danger)' : 'var(--success)'}">
                            ${f.currentDue > 0 ? 'Due: â‚¹'+f.currentDue : 'Paid'}
                        </div>
                        <small>Total Paid: â‚¹${f.paid}</small>
                    </td>
                    <td>
                        <button class="action-btn btn-pay" onclick="openPay('${s.id}')"><i class="fas fa-plus"></i></button>
                        <button class="action-btn btn-drop" onclick="markDropout('${s.id}')" title="Drop Out"><i class="fas fa-user-slash"></i></button>
                        <a href="https://wa.me/${s.phone}" target="_blank" class="action-btn" style="background:#25D366"><i class="fab fa-whatsapp"></i></a>
                    </td>
                </tr>`;
        });
    }

    // --- DASHBOARD CALCS ---
    function updateDashboard() {
        let activeCount = 0, dropCount = 0;
        let totalRev = 0, marketDue = 0, projectedRev = 0;
        let totalExp = 0;

        students.forEach(s => {
            const f = getFinance(s);
            totalRev += f.paid; // Collect money from active AND dropouts
            
            if(s.status === 'dropout') {
                dropCount++;
            } else {
                activeCount++;
                marketDue += f.currentDue;
                projectedRev += f.totalProjected;
            }
        });

        expenses.forEach(e => totalExp += e.amount);

        // UI Updates
        document.getElementById('d_active').innerText = activeCount;
        document.getElementById('d_dropout').innerText = dropCount;
        document.getElementById('d_collected').innerText = 'â‚¹' + totalRev.toLocaleString();
        document.getElementById('d_due').innerText = 'â‚¹' + marketDue.toLocaleString();
        document.getElementById('d_projected').innerText = 'â‚¹' + projectedRev.toLocaleString();
        document.getElementById('d_expense').innerText = 'â‚¹' + totalExp.toLocaleString();
        
        const profit = totalRev - totalExp;
        const profitEl = document.getElementById('d_profit');
        profitEl.innerText = 'â‚¹' + profit.toLocaleString();
        profitEl.style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    // --- PAYMENTS ---
    function openPay(id) {
        currentId = id; document.getElementById('modal').style.display='flex';
    }
    function submitPay() {
        const amt = Number(document.getElementById('payAmount').value);
        const type = document.getElementById('payType').value;
        if(amt>0 && currentId) {
            const s = students.find(x=>x.id===currentId);
            const newPay = { date: new Date().toISOString(), amount: amt, type: type };
            db.ref('students/'+currentId+'/payments').set([...(s.payments||[]), newPay]);
            document.getElementById('modal').style.display='none';
            document.getElementById('payAmount').value='';
            const text = `ðŸ§¾ *RECEIPT*\nName: ${s.name}\nPaid: â‚¹${amt} (${type})\nThank you!`;
            window.open(`https://wa.me/${s.phone}?text=${encodeURIComponent(text)}`, '_blank');
        }
    }

    // --- NAV ---
    function navigate(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const map = {'dashboard':'btn-dash', 'admission':'btn-adm', 'students':'btn-std', 'expenses':'btn-exp'};
        if(map[id]) document.getElementById(map[id]).classList.add('active');
        document.querySelector('.main').scrollTop = 0;
    }

    // Init
    document.getElementById('joinDate').valueAsDate = new Date();
    document.getElementById('expDate').valueAsDate = new Date();
    setDefaults();
</script>
</body>
</html>

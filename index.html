<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIKARKHANJI JNYCTSD</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #0ea5e9;       
            --primary-dark: #0284c7;  
            --bg: #f8fafc;
            --white: #ffffff;
            --text: #1e293b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 280px; 
            background: linear-gradient(180deg, #f0f9ff 0%, #ffffff 100%);
            padding: 25px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.05); 
            z-index: 100;
            border-right: 1px solid #bae6fd;
        }

        .brand { margin-bottom: 30px; border-bottom: 2px solid #bae6fd; padding-bottom: 20px; }
        .brand h1 { font-size: 1.3rem; font-weight: 800; color: var(--primary-dark); line-height: 1.2; text-transform: uppercase; }
        .brand p { font-size: 0.75rem; font-weight: 600; color: #64748b; margin-top: 5px; letter-spacing: 1px; }

        .nav-item {
            padding: 14px;
            margin-bottom: 10px;
            border-radius: 10px;
            color: #475569;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            border: 1px solid transparent;
            user-select: none;
        }
        .nav-item:hover { background: #bae6fd; color: var(--primary-dark); }
        .nav-item.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; padding: 30px; overflow-y: auto; height: 100%; position: relative; }
        
        /* Sections */
        .section { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .section.active { display: block; opacity: 1; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header-title { font-size: 1.6rem; font-weight: 700; color: var(--text); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
        .stat-num { font-size: 1.8rem; font-weight: 700; color: var(--text); margin-top: 5px; }
        .stat-label { color: #64748b; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }

        /* Breakdown Cards */
        .breakdown-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .mini-card { background: white; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; text-align: center; }
        .mini-val { font-size: 1.2rem; font-weight: 700; color: var(--danger); }
        .mini-lbl { font-size: 0.75rem; color: #64748b; margin-top: 2px; }

        /* Chart */
        .chart-box { background: white; padding: 20px; border-radius: 16px; height: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 40px; border: 1px solid #f1f5f9; }

        /* Inputs & Tables */
        .content-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #334155; font-size: 0.9rem; }
        .input-box { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; outline: none; background: #f8fafc; }
        .input-box:focus { border-color: var(--primary); background: white; }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 700; color: white; cursor: pointer; }
        .btn-primary { background: var(--primary); } 

        .table-wrap { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f0f9ff; color: var(--primary-dark); padding: 15px; text-align: left; font-size: 0.8rem; font-weight: 700; border-bottom: 2px solid #bae6fd; }
        td { padding: 14px; border-bottom: 1px solid #e2e8f0; color: #334155; }

        /* Buttons */
        .action-btn { width: 34px; height: 34px; border-radius: 50%; border: none; color: white; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-right: 5px; }
        .btn-pay-now { background: var(--success); padding: 6px 15px; border-radius: 6px; color: white; font-size: 0.8rem; border: none; cursor: pointer; font-weight: 600; }

        /* Modal */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:200; justify-content:center; align-items:center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 380px; }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; width: 100%; height: 70px; flex-direction: row; justify-content: space-around; padding: 10px; border-top: 2px solid #bae6fd; border-right: none; background: white; }
            .brand { display: none; }
            .nav-item { flex-direction: column; gap: 4px; font-size: 0.7rem; padding: 8px; border-radius: 8px; margin: 0; }
            .main { padding: 20px; padding-bottom: 90px; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">
            <h1>TIKARKHANJI<br>JNYCTSD</h1>
            <p>FEE MANAGEMENT SYSTEM</p>
        </div>
        <div class="nav-item active" id="btn-dash" onclick="navigate('dashboard')">
            <i class="fas fa-chart-pie fa-lg"></i> <span>Dashboard</span>
        </div>
        <div class="nav-item" id="btn-adm" onclick="navigate('admission')">
            <i class="fas fa-user-plus fa-lg"></i> <span>Admission</span>
        </div>
        <div class="nav-item" id="btn-std" onclick="navigate('students')">
            <i class="fas fa-list fa-lg"></i> <span>Students</span>
        </div>
    </div>

    <div class="main">
        
        <div id="dashboard" class="section active">
            <div class="header-title"><i class="fas fa-chart-line" style="color:var(--primary)"></i> Financial Overview</div>
            
            <div class="stats-grid">
                <div class="stat-card" style="border-color: #0ea5e9;">
                    <div class="stat-label">Total Students</div>
                    <div class="stat-num" id="d_students">0</div>
                </div>
                <div class="stat-card" style="border-color: #10b981;">
                    <div class="stat-label">Total Collected</div>
                    <div class="stat-num" style="color:#10b981" id="d_collected">â‚¹0</div>
                </div>
                <div class="stat-card" style="border-color: #ef4444;">
                    <div class="stat-label">Total Pending</div>
                    <div class="stat-num" style="color:#ef4444" id="d_due">â‚¹0</div>
                </div>
            </div>

            <h4 style="margin-bottom:15px; color:#64748b; font-weight:600; text-transform:uppercase; font-size:0.85rem;">ðŸ“Œ Pending Dues Breakdown</h4>
            <div class="breakdown-grid">
                <div class="mini-card">
                    <div class="mini-val" id="d_due_adm">â‚¹0</div>
                    <div class="mini-lbl">Admission Due</div>
                </div>
                <div class="mini-card">
                    <div class="mini-val" id="d_due_mon">â‚¹0</div>
                    <div class="mini-lbl">Monthly Due</div>
                </div>
                <div class="mini-card">
                    <div class="mini-val" id="d_due_exam">â‚¹0</div>
                    <div class="mini-lbl">Exam Fee Due</div>
                </div>
            </div>

            <div class="chart-box">
                <canvas id="financeChart"></canvas>
            </div>
        </div>

        <div id="admission" class="section">
            <div class="header-title">ðŸ‘¤ New Admission</div>
            <div class="content-card">
                <form id="admForm">
                    <div class="form-group"><label>Student Name</label><input type="text" id="name" required class="input-box"></div>
                    <div class="form-group"><label>Batch</label><input type="text" id="batch" required class="input-box"></div>
                    <div class="form-group"><label>Phone (WhatsApp)</label><input type="number" id="phone" required class="input-box"></div>
                    <div class="form-group"><label>Joining Date</label><input type="date" id="joinDate" required class="input-box"></div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div class="form-group"><label>Adm. Fee</label><input type="number" id="admFee" value="400" class="input-box"></div>
                        <div class="form-group"><label>Monthly Fee</label><input type="number" id="monthlyFee" value="300" class="input-box"></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div class="form-group"><label>Duration</label><input type="number" id="duration" value="12" class="input-box"></div>
                        <div class="form-group"><label>Exam Fee</label><input type="number" id="examFee" value="500" class="input-box"></div>
                    </div>

                    <button type="submit" class="btn btn-primary">Confirm Admission</button>
                </form>
            </div>
        </div>

        <div id="students" class="section">
            <div class="header-title">ðŸ“‹ Student Records</div>
            <div class="content-card">
                <input type="text" id="search" placeholder="ðŸ” Search Name..." onkeyup="renderTable()" class="input-box">
                <div class="table-wrap">
                    <table id="table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Contact</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3>ðŸ’° Collect Payment</h3><br>
            <div class="form-group">
                <label>Type</label>
                <select id="payType" class="input-box">
                    <option>Monthly Fee</option>
                    <option>Admission Fee</option>
                    <option>Exam Fee</option>
                </select>
            </div>
            <div class="form-group">
                <label>Amount (â‚¹)</label>
                <input type="number" id="payAmount" class="input-box">
            </div>
            <button onclick="submitPay()" class="btn btn-primary">Confirm</button>
            <button onclick="document.getElementById('modal').style.display='none'" class="btn" style="background:#e2e8f0; color:#333; margin-top:10px;">Cancel</button>
        </div>
    </div>

<script>
    // --- 1. SAFE INITIALIZATION ---
    let students = [];
    try {
        students = JSON.parse(localStorage.getItem('tikarkhanji_pro_v3')) || [];
    } catch (e) {
        students = [];
    }

    // AUTO-REPAIR DATA (Fixes the "Button Not Working" issue caused by old data)
    students.forEach(s => {
        if (!s.payments) s.payments = [];
        if (!s.admFee) s.admFee = 0;
        if (!s.monthlyFee) s.monthlyFee = 0;
        if (!s.examFee) s.examFee = 0;
    });

    let currentId = null;
    let financeChart = null;

    // --- 2. NAVIGATION (Simplified & Robust) ---
    window.navigate = function(targetId) {
        // Update UI Classes first (Visual feedback)
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));

        const targetSection = document.getElementById(targetId);
        if(targetSection) targetSection.classList.add('active');

        // Update Active Button
        if(targetId === 'dashboard') document.getElementById('btn-dash').classList.add('active');
        if(targetId === 'admission') document.getElementById('btn-adm').classList.add('active');
        if(targetId === 'students') document.getElementById('btn-std').classList.add('active');

        // Logic
        if(targetId === 'dashboard') updateDashboard();
        if(targetId === 'students') renderTable();
    }

    // --- 3. ON LOAD ---
    window.onload = () => {
        document.getElementById('joinDate').valueAsDate = new Date();
        renderTable();
        updateDashboard();
    };

    function saveData() {
        localStorage.setItem('tikarkhanji_pro_v3', JSON.stringify(students));
        updateDashboard();
        renderTable();
    }

    // --- 4. ADMISSION LOGIC ---
    document.getElementById('admForm').addEventListener('submit', (e) => {
        e.preventDefault();
        try {
            const s = {
                id: Date.now(),
                name: document.getElementById('name').value,
                batch: document.getElementById('batch').value,
                phone: document.getElementById('phone').value,
                joinDate: document.getElementById('joinDate').value,
                admFee: Number(document.getElementById('admFee').value) || 0,
                monthlyFee: Number(document.getElementById('monthlyFee').value) || 0,
                duration: Number(document.getElementById('duration').value) || 12,
                examFee: Number(document.getElementById('examFee').value) || 0,
                payments: []
            };
            students.push(s);
            saveData();
            e.target.reset();
            
            // Restore defaults
            document.getElementById('admFee').value = "400";
            document.getElementById('monthlyFee').value = "300";
            document.getElementById('examFee').value = "500";
            document.getElementById('duration').value = "12";
            document.getElementById('joinDate').valueAsDate = new Date();
            
            alert("Student Added!");
            navigate('students');
        } catch (err) {
            alert("Error adding student. Please check inputs.");
            console.error(err);
        }
    });

    // --- 5. CALCULATIONS ---
    function getFinance(s) {
        // Safety checks for undefined values
        const aFee = s.admFee || 0;
        const mFee = s.monthlyFee || 0;
        const dur = s.duration || 0;
        const eFee = s.examFee || 0;
        const pays = s.payments || [];

        const totalAdm = aFee;
        const totalMon = mFee * dur;
        const totalExam = eFee;
        const total = totalAdm + totalMon + totalExam;

        let paidAdm = 0, paidMon = 0, paidExam = 0;
        
        pays.forEach(p => {
            if(p.type === 'Admission Fee') paidAdm += p.amount;
            else if(p.type === 'Monthly Fee') paidMon += p.amount;
            else if(p.type === 'Exam Fee') paidExam += p.amount;
        });

        const paidTotal = paidAdm + paidMon + paidExam;

        return {
            total,
            paid: paidTotal,
            due: total - paidTotal,
            breakdown: {
                admDue: totalAdm - paidAdm,
                monDue: totalMon - paidMon,
                examDue: totalExam - paidExam
            }
        };
    }

    // --- 6. RENDER TABLE ---
    function renderTable() {
        const tbody = document.getElementById('tbody');
        const search = document.getElementById('search').value.toLowerCase();
        tbody.innerHTML = '';

        const filtered = students.filter(s => (s.name || "").toLowerCase().includes(search) || (s.phone || "").includes(search)).reverse();

        filtered.forEach(s => {
            const f = getFinance(s);
            const tr = document.createElement('tr');
            
            let status = f.due > 0 
                ? `<span style="color:#ef4444; background:#fee2e2; padding:3px 8px; border-radius:4px; font-weight:700; font-size:0.8rem;">Due: â‚¹${f.due}</span>` 
                : `<span style="color:#10b981; background:#dcfce7; padding:3px 8px; border-radius:4px; font-weight:700; font-size:0.8rem;">Paid Full</span>`;

            let noticeBtn = '';
            if(f.due > 0) {
                noticeBtn = `<button class="action-btn" style="background:#f59e0b" onclick="sendReminder(${s.id})"><i class="fas fa-bell"></i></button>`;
            }

            tr.innerHTML = `
                <td>
                    <div style="font-weight:700; color:#1e293b">${s.name}</div>
                    <div style="font-size:0.75rem; color:#64748b; background:#f1f5f9; display:inline-block; padding:2px 6px; border-radius:4px;">${s.batch}</div>
                </td>
                <td>
                    <div style="font-weight:600">${s.phone}</div>
                    <div style="margin-top:5px;">
                        <a href="tel:${s.phone}" class="action-btn" style="background:#3b82f6"><i class="fas fa-phone"></i></a>
                        <a href="https://wa.me/${s.phone}" target="_blank" class="action-btn" style="background:#22c55e"><i class="fab fa-whatsapp"></i></a>
                        ${noticeBtn}
                    </div>
                </td>
                <td>
                    <div style="color:#10b981; font-weight:700; font-size:0.9rem;">Paid: â‚¹${f.paid}</div>
                    <div style="margin-top:4px;">${status}</div>
                </td>
                <td>
                    <button class="btn-pay-now" onclick="openPay(${s.id})">Pay</button>
                    <button class="action-btn" style="background:#ef4444; width:28px; height:28px; margin-left:5px;" onclick="del(${s.id})"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- 7. DASHBOARD & CHART ---
        function updateDashboard() {
        try {
            let totalDue = 0, totalCollected = 0;
            let dueAdm = 0, dueMon = 0, dueExam = 0;
            const monthlyData = {};

            students.forEach(s => {
                const f = getFinance(s);
                totalCollected += f.paid;
                totalDue += f.due;
                
                dueAdm += Math.max(0, f.breakdown.admDue);
                dueMon += Math.max(0, f.breakdown.monDue);
                dueExam += Math.max(0, f.breakdown.examDue);

                (s.payments || []).forEach(p => {
                    const d = new Date(p.date);
                    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    if(!monthlyData[key]) monthlyData[key] = 0;
                    monthlyData[key] += p.amount;
                });
            });

            document.getElementById('d_students').innerText = students.length;
            document.getElementById('d_collected').innerText = 'â‚¹' + totalCollected;
            document.getElementById('d_due').innerText = 'â‚¹' + totalDue;
            document.getElementById('d_due_adm').innerText = 'â‚¹' + dueAdm;
            document.getElementById('d_due_mon').innerText = 'â‚¹' + dueMon;
            document.getElementById('d_due_exam').innerText = 'â‚¹' + dueExam;

            // Chart Logic (Safe Check)
            const ctx = document.getElementById('financeChart');
            if (ctx && typeof Chart !== 'undefined') {
                const context = ctx.getContext('2d');
                if(financeChart) financeChart.destroy();

                const sortedKeys = Object.keys(monthlyData).sort();
                const labels = sortedKeys.map(k => {
                    const [y, m] = k.split('-');
                    return new Date(y, m-1).toLocaleString('default', { month: 'short', year: '2-digit' });
                });
                const data = sortedKeys.map(k => monthlyData[k]);

                const gradient = context.createLinearGradient(0,0,0,400);
                gradient.addColorStop(0, '#0ea5e9'); gradient.addColorStop(1, '#0284c7');

                financeChart = new Chart(context, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{ label: 'Collection', data: data, backgroundColor: gradient, borderRadius: 6 }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }
                    }
                });
            }
        } catch (err) {
            console.log("Chart Error (Ignored):", err);
        }
    }

    // --- 8. ACTIONS ---
    function openPay(id) { currentId = id; document.getElementById('modal').style.display='flex'; }
    
    function submitPay() {
        const amt = Number(document.getElementById('payAmount').value);
        const type = document.getElementById('payType').value;
        if(amt > 0 && currentId) {
            const s = students.find(x => x.id === currentId);
            s.payments.push({ date: new Date().toISOString(), amount: amt, type: type });
            saveData();
            document.getElementById('modal').style.display='none';
            document.getElementById('payAmount').value = '';

            // Professional Bill
            const f = getFinance(s);
            const dateStr = new Date().toLocaleDateString('en-IN');
            const msg = `ðŸ§¾ *OFFICIAL RECEIPT*\n------------------\nðŸŽ“ *TIKARKHANJI JNYCTSD*\n------------------\nName: ${s.name}\nBatch: ${s.batch}\nDate: ${dateStr}\n\nðŸ’° *Paid: â‚¹${amt}*\nðŸ“Œ Type: ${type}\n\nðŸ“‰ *Remaining Due: â‚¹${f.due}*\n------------------\nThank you!`;
            window.open(`https://wa.me/${s.phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }
    }

    function sendReminder(id) {
        const s = students.find(x => x.id === id);
        const f = getFinance(s);
        let breakdownTxt = "";
        if(f.breakdown.admDue > 0) breakdownTxt += `â€¢ Admission: â‚¹${f.breakdown.admDue}\n`;
        if(f.breakdown.monDue > 0) breakdownTxt += `â€¢ Monthly: â‚¹${f.breakdown.monDue}\n`;
        if(f.breakdown.examDue > 0) breakdownTxt += `â€¢ Exam Fee: â‚¹${f.breakdown.examDue}\n`;

        const msg = `âš ï¸ *PAYMENT REMINDER*\nDear ${s.name},\nPending fees at TIKARKHANJI JNYCTSD:\n\n${breakdownTxt}------------------\nðŸ“‰ *TOTAL DUE: â‚¹${f.due}*\n------------------\nPlease pay soon.`;
        window.open(`https://wa.me/${s.phone}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function del(id) { if(confirm("Delete Student?")) { students = students.filter(x=>x.id!==id); saveData(); } }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIKARKHANJI JNYCTSD</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #0ea5e9; --primary-dark: #0284c7; --bg: #f8fafc; --white: #ffffff; --text: #1e293b; --success: #10b981; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); display: flex; height: 100vh; overflow: hidden; }

        /* Login Screen */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { text-align: center; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); background: #f0f9ff; width: 90%; max-width: 400px; }
        .google-btn { background: #4285F4; color: white; border: none; padding: 12px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; margin: 20px auto; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* App UI */
        .sidebar { width: 280px; background: linear-gradient(180deg, #f0f9ff 0%, #ffffff 100%); padding: 25px; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 100; border-right: 1px solid #bae6fd; }
        .brand { margin-bottom: 30px; border-bottom: 2px solid #bae6fd; padding-bottom: 20px; }
        .brand h1 { font-size: 1.3rem; font-weight: 800; color: var(--primary-dark); line-height: 1.2; }
        .nav-item { padding: 14px; margin-bottom: 10px; border-radius: 10px; color: #475569; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .nav-item.active { background: var(--primary); color: white; }
        .main { flex: 1; padding: 30px; overflow-y: auto; height: 100vh; padding-bottom: 120px; display: none; } /* Scroll fix */
        
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .breakdown-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .mini-card { background: white; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; text-align: center; }
        
        .chart-box { background: white; padding: 15px; border-radius: 16px; height: 350px; margin-bottom: 30px; }
        .content-card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; }
        .input-box { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; outline: none; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: 700; color: white; cursor: pointer; background: var(--primary); margin-top: 10px; }
        
        table { width: 100%; border-collapse: collapse; min-width: 600px; margin-top: 15px; }
        th { background: #f0f9ff; padding: 12px; text-align: left; font-size: 0.8rem; border-bottom: 2px solid #bae6fd; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
        .action-btn { width: 34px; height: 34px; border-radius: 50%; border: none; color: white; cursor: pointer; margin-right: 5px; }
        
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:200; justify-content:center; align-items:center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 380px; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; flex-direction: row; justify-content: space-around; padding: 10px; border-top: 2px solid #bae6fd; z-index: 1000; background: white;}
            .brand { display: none; }
            .nav-item { flex-direction: column; gap: 4px; font-size: 0.7rem; padding: 8px; margin: 0; }
            .main { padding: 20px; padding-bottom: 120px; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color: var(--primary-dark); margin-bottom: 10px;">TIKARKHANJI JNYCTSD</h2>
            <p>Admin Access Only</p>
            <br>
            <button class="google-btn" onclick="googleLogin()">
                <i class="fab fa-google"></i> Login with Google
            </button>
            <br>
            <div class="loader" id="loader"></div>
            <p id="login-status" style="margin-top: 15px; color: red; font-size: 0.9rem;"></p>
        </div>
    </div>

    <div class="sidebar" id="sidebar" style="display: none;">
        <div class="brand"><h1>TIKARKHANJI<br>JNYCTSD</h1><p>FEE MANAGEMENT</p></div>
        <div class="nav-item active" id="btn-dash" onclick="navigate('dashboard')"><i class="fas fa-chart-pie"></i><span>Dashboard</span></div>
        <div class="nav-item" id="btn-adm" onclick="navigate('admission')"><i class="fas fa-user-plus"></i><span>Admission</span></div>
        <div class="nav-item" id="btn-std" onclick="navigate('students')"><i class="fas fa-list"></i><span>Students</span></div>
        <div class="nav-item" style="margin-top: auto; background: #fee2e2; color: #ef4444;" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></div>
    </div>

    <div class="main" id="main-content">
        <div id="dashboard" class="section active">
            <h2 style="margin-bottom:20px">üìä Dashboard</h2>
            <div class="stats-grid">
                <div class="stat-card"><h3>Students</h3><h1 id="d_students">0</h1></div>
                <div class="stat-card" style="border-color:#10b981"><h3>Collected</h3><h1 style="color:#10b981" id="d_collected">‚Çπ0</h1></div>
                <div class="stat-card" style="border-color:#ef4444"><h3>Total Pending (Admin)</h3><h1 style="color:#ef4444" id="d_due">‚Çπ0</h1></div>
            </div>
            <div class="breakdown-grid">
                <div class="mini-card"><h3 style="color:#ef4444" id="d_due_adm">‚Çπ0</h3><p>Admission Due</p></div>
                <div class="mini-card"><h3 style="color:#ef4444" id="d_due_mon">‚Çπ0</h3><p>Monthly Due</p></div>
                <div class="mini-card" style="background:#fff7ed"><h3 style="color:#ea580c" id="d_due_exam">‚Çπ0</h3><p>Exam Due (Hidden)</p></div>
            </div>
            <div class="chart-box"><canvas id="financeChart"></canvas></div>
            <div style="height: 50px;"></div>
        </div>

        <div id="admission" class="section">
            <h2 style="margin-bottom:20px">üë§ New Admission</h2>
            <div class="content-card">
                <form id="admForm">
                    <input type="text" id="name" required class="input-box" placeholder="Student Name">
                    <input type="text" id="batch" required class="input-box" placeholder="Batch Name">
                    <input type="number" id="phone" required class="input-box" placeholder="Phone Number">
                    <input type="date" id="joinDate" required class="input-box">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                        <input type="number" id="admFee" value="400" class="input-box" placeholder="Adm Fee">
                        <input type="number" id="monthlyFee" value="300" class="input-box" placeholder="Monthly Fee">
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                        <input type="number" id="duration" value="12" class="input-box" placeholder="Months">
                        <input type="number" id="examFee" value="500" class="input-box" placeholder="Exam Fee">
                    </div>
                    <button type="submit" class="btn">Add Student</button>
                </form>
            </div>
            <div style="height: 50px;"></div>
        </div>

        <div id="students" class="section">
            <h2 style="margin-bottom:20px">üìã Student List</h2>
            <div class="content-card">
                <input type="text" id="search" placeholder="Search..." onkeyup="renderTable()" class="input-box">
                <div style="overflow-x:auto"><table id="table"><thead><tr><th>Name</th><th>Contact</th><th>Due (Total)</th><th>Action</th></tr></thead><tbody id="tbody"></tbody></table></div>
            </div>
            <div style="height: 50px;"></div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3>üí∞ Collect Payment</h3><br>
            <select id="payType" class="input-box">
                <option>Monthly Fee</option><option>Admission Fee</option><option>Exam Fee</option>
            </select>
            <input type="number" id="payAmount" class="input-box" placeholder="Amount">
            <button onclick="submitPay()" class="btn">Confirm</button>
            <button onclick="document.getElementById('modal').style.display='none'" class="btn" style="background:#e2e8f0; color:#333">Cancel</button>
        </div>
    </div>

<script>
    // üî• YOUR FIREBASE CONFIG (Copied from your screenshot) üî•
    const firebaseConfig = {
        apiKey: "AIzaSyCUmRYc8WtQP3LW_85i5Czore9YjWw0yLU",
        authDomain: "tikarkhanjijnyctsd.firebaseapp.com",
        databaseURL: "https://tikarkhanjijnyctsd-default-rtdb.firebaseio.com",
        projectId: "tikarkhanjijnyctsd",
        storageBucket: "tikarkhanjijnyctsd.firebasestorage.app",
        messagingSenderId: "513267646081",
        appId: "1:513267646081:web:1b60262e26e5e6dcef9780"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    // üîê ADMIN EMAIL (‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶õ‡¶æ‡ßú‡¶æ ‡¶ï‡ßá‡¶â ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ)
    const ADMIN_EMAIL = "achintyaghosh37@gmail.com"; 

    // --- VARIABLES ---
    let students = [];
    let currentId = null;
    let financeChart = null;

    // --- AUTHENTICATION ---
    function googleLogin() {
        document.getElementById('loader').style.display = 'block';
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(err => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('login-status').innerText = err.message;
            if(err.code === 'auth/unauthorized-domain') {
                alert("Error: Please make sure 'github.io' is added in Firebase Authorized Domains.");
            }
        });
    }

    function logout() {
        auth.signOut();
        location.reload();
    }

    auth.onAuthStateChanged(user => {
        document.getElementById('loader').style.display = 'none';
        if (user) {
            if (user.email === ADMIN_EMAIL) {
                // Success: Show App
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('sidebar').style.display = 'flex';
                document.getElementById('main-content').style.display = 'block';
                loadData();
            } else {
                // Fail: Wrong Email
                auth.signOut();
                alert("Access Denied! You are not the Admin.");
            }
        } else {
            // Not Logged In
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
        }
    });

    // --- DATABASE (REALTIME) ---
    function loadData() {
        db.ref('students').on('value', (snapshot) => {
            const data = snapshot.val();
            students = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
            // Repair Data
            students.forEach(s => {
                if (!s.payments) s.payments = [];
                s.admFee = s.admFee || 0; s.monthlyFee = s.monthlyFee || 0; s.examFee = s.examFee || 0;
            });
            updateDashboard();
            renderTable();
        });
    }

    function saveDataToFirebase(studentData) {
        db.ref('students').push(studentData);
    }

    function deleteFromFirebase(id) {
        if(confirm("Delete this student permanently?")) {
            db.ref('students/' + id).remove();
        }
    }

    // --- APP LOGIC ---
    function navigate(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id==='dashboard') document.getElementById('btn-dash').classList.add('active');
        if(id==='admission') document.getElementById('btn-adm').classList.add('active');
        if(id==='students') document.getElementById('btn-std').classList.add('active');
    }

    // Admission
    document.getElementById('admForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const s = {
            name: document.getElementById('name').value,
            batch: document.getElementById('batch').value,
            phone: document.getElementById('phone').value,
            joinDate: document.getElementById('joinDate').value,
            admFee: Number(document.getElementById('admFee').value),
            monthlyFee: Number(document.getElementById('monthlyFee').value),
            duration: Number(document.getElementById('duration').value),
            examFee: Number(document.getElementById('examFee').value),
            payments: []
        };
        saveDataToFirebase(s);
        e.target.reset();
        alert("Student Added!");
        navigate('students');
    });

    // Calculations
    function getFinance(s) {
        const total = s.admFee + (s.monthlyFee * s.duration) + s.examFee;
        let paidAdm=0, paidMon=0, paidExam=0;
        (s.payments || []).forEach(p => {
            if(p.type==='Admission Fee') paidAdm+=p.amount;
            else if(p.type==='Monthly Fee') paidMon+=p.amount;
            else if(p.type==='Exam Fee') paidExam+=p.amount;
        });
        const totalPaid = paidAdm + paidMon + paidExam;
        return {
            total, paid: totalPaid, due: total - totalPaid,
            bd: { adm: s.admFee-paidAdm, mon: (s.monthlyFee*s.duration)-paidMon, exam: s.examFee-paidExam }
        };
    }

    // Render Table
    function renderTable() {
        const tbody = document.getElementById('tbody');
        const search = document.getElementById('search').value.toLowerCase();
        tbody.innerHTML = '';
        
        students.filter(s => s.name.toLowerCase().includes(search)).reverse().forEach(s => {
            const f = getFinance(s);
            let status = f.due > 0 ? `<span style='color:red; font-weight:bold'>Due: ‚Çπ${f.due}</span>` : `<span style='color:green; font-weight:bold'>Paid</span>`;
            
            // Logic: Hide bell if only Exam fee is due
            let studentVisibleDue = Math.max(0, f.bd.adm) + Math.max(0, f.bd.mon);
            let bellBtn = studentVisibleDue > 0 ? 
                `<button class="action-btn" style="background:#f59e0b" onclick="sendReminder('${s.id}')"><i class="fas fa-bell"></i></button>` : '';

            tbody.innerHTML += `
                <tr>
                    <td><b>${s.name}</b><br><small style="color:#64748b">${s.batch}</small></td>
                    <td>${s.phone}<br>
                        <a href="tel:${s.phone}" class="action-btn" style="background:#3b82f6; padding:5px;"><i class="fas fa-phone"></i></a>
                        <a href="https://wa.me/${s.phone}" target="_blank" class="action-btn" style="background:#22c55e; padding:5px;"><i class="fab fa-whatsapp"></i></a>
                        ${bellBtn}
                    </td>
                    <td>Paid: ‚Çπ${f.paid}<br>${status}</td>
                    <td>
                        <button class="action-btn" style="background:#10b981" onclick="openPay('${s.id}')"><i class="fas fa-plus"></i></button>
                        <button class="action-btn" style="background:#ef4444" onclick="deleteFromFirebase('${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });
    }

    // Dashboard
    function updateDashboard() {
        let tCol=0, tDue=0, dAdm=0, dMon=0, dExam=0;
        const monthlyData = {};

        students.forEach(s => {
            const f = getFinance(s);
            tCol += f.paid; tDue += f.due;
            dAdm += Math.max(0, f.bd.adm); dMon += Math.max(0, f.bd.mon); dExam += Math.max(0, f.bd.exam);

            (s.payments||[]).forEach(p => {
                const d = new Date(p.date);
                const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                monthlyData[k] = (monthlyData[k]||0) + p.amount;
            });
        });

        document.getElementById('d_students').innerText = students.length;
        document.getElementById('d_collected').innerText = '‚Çπ' + tCol;
        document.getElementById('d_due').innerText = '‚Çπ' + tDue;
        document.getElementById('d_due_adm').innerText = '‚Çπ' + dAdm;
        document.getElementById('d_due_mon').innerText = '‚Çπ' + dMon;
        document.getElementById('d_due_exam').innerText = '‚Çπ' + dExam;

        const ctx = document.getElementById('financeChart');
        if (ctx) {
            if(financeChart) financeChart.destroy();
            const keys = Object.keys(monthlyData).sort();
            financeChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: { labels: keys, datasets: [{ label: 'Collection', data: keys.map(k=>monthlyData[k]), backgroundColor: '#0ea5e9', borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    }

    // Payment
    function openPay(id) { currentId = id; document.getElementById('modal').style.display='flex'; }
    function submitPay() {
        const amt = Number(document.getElementById('payAmount').value);
        const type = document.getElementById('payType').value;
        if(amt > 0 && currentId) {
            const s = students.find(x => x.id === currentId);
            const newPayment = { date: new Date().toISOString(), amount: amt, type: type };
            // Update Firebase
            const updatedPayments = [...(s.payments||[]), newPayment];
            db.ref('students/' + currentId + '/payments').set(updatedPayments);
            
            document.getElementById('modal').style.display='none';
            document.getElementById('payAmount').value = '';
            
            // Receipt
            const text = `üßæ *RECEIPT*%0a------------------%0aName: ${s.name}%0aBatch: ${s.batch}%0aüí∞ *Paid: ‚Çπ${amt}* (${type})%0a------------------%0aThank you!`;
            window.open(`https://wa.me/${s.phone}?text=${text}`, '_blank');
        }
    }

    // Reminder (Hides Exam Fee)
    function sendReminder(id) {
        const s = students.find(x => x.id === id);
        const f = getFinance(s);
        const studentDue = Math.max(0, f.bd.adm) + Math.max(0, f.bd.mon);
        
        if(studentDue <= 0) {
            alert("Only Exam Fee Pending. No SMS sent."); return;
        }

        let bd = "";
        if(f.bd.adm > 0) bd += `‚Ä¢ Admission: ‚Çπ${f.bd.adm}%0a`;
        if(f.bd.mon > 0) bd += `‚Ä¢ Monthly: ‚Çπ${f.bd.mon}%0a`;

        const text = `‚ö†Ô∏è *FEE REMINDER*%0a------------------%0aDear ${s.name},%0aYour fees are pending at TIKARKHANJI JNYCTSD.%0a%0aüìä *Breakdown:*%0a${bd}%0aüìâ *TOTAL DUE: ‚Çπ${studentDue}*%0a------------------%0aPlease pay soon.`;
        window.open(`https://wa.me/${s.phone}?text=${text}`, '_blank');
    }

    document.getElementById('joinDate').valueAsDate = new Date();
</script>
</body>
</html>

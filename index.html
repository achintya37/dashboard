<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIKARKHANJI JNYCTSD - Admin Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --primary: #2563eb; --bg: #f3f4f6; --white: #ffffff; 
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; 
            --purple: #8b5cf6; --text: #1f2937;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); display: flex; height: 100vh; overflow: hidden; }

        /* Login */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { text-align: center; padding: 40px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); background: #fff; width: 90%; max-width: 400px; }
        .google-btn { background: #4285F4; color: white; border: none; padding: 12px 25px; border-radius: 50px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; margin: 20px auto; box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3); }

        /* Sidebar */
        .sidebar { width: 280px; background: #fff; padding: 25px; display: flex; flex-direction: column; box-shadow: 4px 0 20px rgba(0,0,0,0.02); z-index: 100; border-right: 1px solid #e5e7eb; }
        .brand { margin-bottom: 40px; border-bottom: 2px solid #f3f4f6; padding-bottom: 20px; }
        .brand h1 { font-size: 1.4rem; font-weight: 800; color: var(--primary); line-height: 1.2; }
        .nav-item { padding: 14px 18px; margin-bottom: 8px; border-radius: 12px; color: #6b7280; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 14px; transition: all 0.2s ease; }
        .nav-item.active { background: #eff6ff; color: var(--primary); border-left: 4px solid var(--primary); }

        /* Main */
        .main { flex: 1; padding: 30px; overflow-y: auto; height: 100vh; padding-bottom: 120px; display: none; }
        .section { display: none; animation: fadeIn 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 16px; position: relative; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: var(--text); margin-top: 5px; }
        .stat-label { font-size: 0.85rem; font-weight: 600; color: #6b7280; text-transform: uppercase; }

        /* Yearly Grid */
        .yearly-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-top: 15px; }
        .month-box { background: white; border: 1px solid #e5e7eb; padding: 10px; border-radius: 10px; text-align: center; }
        .month-box h4 { font-size: 0.75rem; color: #6b7280; margin-bottom: 5px; text-transform: uppercase; }
        .month-box p { font-weight: 700; color: var(--primary); font-size: 0.9rem; }

        /* Content & Form */
        .content-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .input-box, select { width: 100%; padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 10px; margin-bottom: 15px; outline: none; background: #fff; font-size: 0.95rem; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; background: var(--primary); font-size: 1rem; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f9fafb; padding: 15px; text-align: left; font-size: 0.8rem; font-weight: 700; color: #6b7280; border-bottom: 2px solid #e5e7eb; }
        td { padding: 15px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; vertical-align: middle; }
        
        .view-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
        .toggle-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid #e5e7eb; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #6b7280; }
        .toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .action-btn { width: 34px; height: 34px; border-radius: 8px; border: none; color: white; cursor: pointer; margin-right: 5px; display: inline-flex; align-items: center; justify-content: center; }
        .btn-pay { background: var(--success); }
        .btn-wa { background: #25D366; }
        .btn-drop { background: #64748b; }
        .btn-restore { background: #2563eb; }
        .btn-del { background: #fee2e2; color: var(--danger); } 
        .btn-del:hover { background: var(--danger); color: white; }

        /* Tracker Specific */
        .tracker-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .tracker-list { background: white; padding: 15px; border-radius: 12px; height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; }
        .tracker-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f3f4f6; }
        .bg-paid { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }

        /* Modal */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:200; justify-content:center; align-items:center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .sidebar { 
                position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; 
                flex-direction: row; justify-content: space-between; padding: 0 10px; 
                border-top: 1px solid #e5e7eb; border-right: none; overflow-x: auto;
                background: white; z-index: 1000;
            }
            .brand { display: none; }
            .nav-item { 
                flex-direction: column; gap: 2px; font-size: 0.6rem; padding: 8px 12px; 
                margin: 0; border-radius: 8px; background: transparent !important; color: #9ca3af; 
                min-width: 60px; justify-content: center; text-align: center; border-left: none !important;
            }
            .nav-item i { font-size: 1.1rem; margin-bottom: 2px; }
            .nav-item.active { color: var(--primary); }
            /* Mobile Logout */
            .nav-item[onclick="logout()"] { color: var(--danger) !important; margin-top: 0 !important; }
            
            .main { padding: 15px; padding-bottom: 100px; }
            .stats-grid, .tracker-cols { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-bottom: 10px;">TIKARKHANJI JNYCTSD</h2>
            <p>Admin Portal</p>
            <button class="google-btn" onclick="googleLogin()">
                <i class="fab fa-google"></i> Login with Google
            </button>
            <div id="loader" style="display:none; margin-top:10px; color:#6b7280; font-size:0.8rem;">Connecting...</div>
            <p id="login-status" style="margin-top: 15px; color: red; font-size: 0.8rem;"></p>
        </div>
    </div>

    <div class="sidebar" id="sidebar" style="display: none;">
        <div class="brand"><h1>TIKARKHANJI<br>JNYCTSD</h1><p>MANAGEMENT PRO</p></div>
        <div class="nav-item active" id="btn-dash" onclick="navigate('dashboard')"><i class="fas fa-th-large"></i><span>Home</span></div>
        <div class="nav-item" id="btn-track" onclick="navigate('monthTracker')"><i class="fas fa-calendar-check"></i><span>Fees</span></div>
        <div class="nav-item" id="btn-adm" onclick="navigate('admission')"><i class="fas fa-user-plus"></i><span>Add</span></div>
        <div class="nav-item" id="btn-std" onclick="navigate('students')"><i class="fas fa-users"></i><span>Students</span></div>
        <div class="nav-item" id="btn-exp" onclick="navigate('expenses')"><i class="fas fa-wallet"></i><span>Exp</span></div>
        <div class="nav-item" style="margin-top: auto; color: var(--danger);" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></div>
    </div>

    <div class="main" id="main-content">
        
        <div id="dashboard" class="section active">
            <h2 style="margin-bottom:20px; color:#111827;">üìä Business Overview</h2>
            <div class="stats-grid">
                <div class="stat-card" style="border-color: #2563eb;">
                    <div class="stat-label">Active Students</div>
                    <div class="stat-val" id="d_active">0</div>
                    <div style="font-size:0.8rem; color:#6b7280; margin-top:5px;">Dropouts: <span id="d_dropout" style="color:var(--danger)">0</span></div>
                </div>
                <div class="stat-card" style="border-color: #10b981;">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-val" style="color:var(--success)" id="d_collected">‚Çπ0</div>
                </div>
                <div class="stat-card" style="border-color: #ef4444;">
                    <div class="stat-label">Market Due (No Exam)</div>
                    <div class="stat-val" style="color:var(--danger)" id="d_due">‚Çπ0</div>
                </div>
                <div class="stat-card" style="border-color: #ec4899;">
                    <div class="stat-label">Total Expense</div>
                    <div class="stat-val" style="color:#ec4899" id="d_expense">‚Çπ0</div>
                </div>
                <div class="stat-card" style="border-color: #000;">
                    <div class="stat-label">Net Profit</div>
                    <div class="stat-val" id="d_profit">‚Çπ0</div>
                </div>
            </div>

            <div class="content-card">
                <h3 style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                    <span>üìà <span id="currentYear"></span> Monthly Collection</span>
                    <span style="font-size:0.8rem; color:var(--primary); font-weight:normal;">Auto-updates</span>
                </h3>
                <div class="yearly-grid" id="yearlyStats"></div>
            </div>
        </div>

        <div id="monthTracker" class="section">
            <h2 style="margin-bottom:20px">üìÖ Monthly Fee Status</h2>
            <div class="content-card">
                <label style="font-weight:600; margin-right:10px;">Select Month:</label>
                <input type="month" id="trackerMonth" class="input-box" style="margin-bottom:20px; width:auto;" onchange="loadTrackerData()">
                
                <div class="tracker-cols">
                    <div class="tracker-list">
                        <h3 style="color:#ef4444; border-bottom:2px solid #ef4444; padding-bottom:10px; margin-bottom:10px; position:sticky; top:0; background:white;">
                            ‚ùå Unpaid (<span id="unpaidCount">0</span>)
                        </h3>
                        <div id="unpaidList"></div>
                    </div>
                    <div class="tracker-list">
                        <h3 style="color:#10b981; border-bottom:2px solid #10b981; padding-bottom:10px; margin-bottom:10px; position:sticky; top:0; background:white;">
                            ‚úÖ Paid (<span id="paidCount">0</span>)
                        </h3>
                        <div id="paidList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admission" class="section">
            <h2 style="margin-bottom:20px">üë§ New Admission</h2>
            <div class="content-card">
                <form id="admForm">
                    <div style="background:#f0f9ff; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #dbeafe;">
                        <label style="font-weight:600; display:block; margin-bottom:8px;">Student Type</label>
                        <select id="studentType" onchange="setDefaults()" class="input-box" style="margin-bottom:10px;">
                            <option value="junior">Junior Student (Class 9 & Below)</option>
                            <option value="senior">Senior Student (Course Based)</option>
                        </select>
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                            <input type="checkbox" id="isOldStudent" onchange="toggleOldStudent()" style="width:18px; height:18px;">
                            Existing Student (0 Admission Fee)
                        </label>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <input type="text" id="name" required class="input-box" placeholder="Full Name">
                        <input type="text" id="batch" required class="input-box" placeholder="Batch Name">
                    </div>
                    <input type="number" id="phone" required class="input-box" placeholder="Mobile Number">
                    <label style="font-size:0.85rem; font-weight:600;">Joining Date</label>
                    <input type="date" id="joinDate" required class="input-box">
                    
                    <div style="background:#f9fafb; padding:15px; border-radius:10px; margin-top:10px;">
                        <h4 style="margin-bottom:10px; color:#6b7280;">Fee Structure</h4>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <input type="number" id="admFee" class="input-box" placeholder="Adm Fee">
                            <input type="number" id="monthlyFee" class="input-box" placeholder="Monthly Fee">
                            <input type="number" id="examFee" class="input-box" placeholder="Exam Fee">
                            <input type="number" id="duration" class="input-box" placeholder="Months">
                        </div>
                    </div>
                    <button type="submit" class="btn">Confirm Admission</button>
                </form>
            </div>
        </div>

        <div id="students" class="section">
            <h2 style="margin-bottom:20px">üìã Student Management</h2>
            <div class="content-card">
                <div class="view-toggle">
                    <button class="toggle-btn active" id="btn-view-active" onclick="switchStudentView('active')">Active Students</button>
                    <button class="toggle-btn" id="btn-view-drop" onclick="switchStudentView('dropout')">Dropout List</button>
                </div>

                <input type="text" id="search" placeholder="üîç Search..." onkeyup="renderTable()" class="input-box">
                <div style="overflow-x:auto">
                    <table id="table">
                        <thead>
                            <tr>
                                <th>Student Details</th>
                                <th>Payment Breakdown</th>
                                <th>Status/Action</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="expenses" class="section">
            <h2 style="margin-bottom:20px">üí∏ Expense Manager</h2>
            <div class="content-card">
                <form id="expForm">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <select id="expCat" class="input-box">
                            <option>Salary</option>
                            <option>Electricity Bill</option>
                            <option>Broadband</option>
                            <option>Computer Repair</option>
                            <option>Room Rent</option>
                            <option>Others</option>
                        </select>
                        <input type="number" id="expAmount" required class="input-box" placeholder="Amount (‚Çπ)">
                    </div>
                    <input type="text" id="expNote" class="input-box" placeholder="Description (Optional)">
                    <input type="date" id="expDate" required class="input-box">
                    <button type="submit" class="btn" style="background:var(--purple)">Add Expense</button>
                </form>
            </div>

            <div class="content-card">
                <h3 style="margin-bottom:15px;">Expense History</h3>
                <div style="overflow-x:auto">
                    <table id="expTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Note</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="expBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3>üí∞ Receive Payment</h3><br>
            <select id="payType" class="input-box">
                <option>Monthly Fee</option>
                <option>Admission Fee</option>
                <option>Exam Fee</option>
            </select>
            <input type="number" id="payAmount" class="input-box" placeholder="Amount">
            <button onclick="submitPay()" class="btn">Confirm & Receipt</button>
            <button onclick="document.getElementById('modal').style.display='none'" class="btn" style="background:#e5e7eb; color:#374151; margin-top:10px;">Close</button>
        </div>
    </div>

<script>
    // üî• FIXED CONFIG üî•
    const firebaseConfig = {
        apiKey: "AIzaSyCUmRYc8WtQP3LW_85i5Czore9YjWw0yLU",
        authDomain: "tikarkhanjijnyctsd.firebaseapp.com",
        databaseURL: "https://tikarkhanjijnyctsd-default-rtdb.firebaseio.com",
        projectId: "tikarkhanjijnyctsd",
        storageBucket: "tikarkhanjijnyctsd.firebasestorage.app",
        messagingSenderId: "513267646081",
        appId: "1:513267646081:web:1b60262e26e5e6dcef9780"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const ADMIN_EMAIL = "achintyaghosh37@gmail.com"; 

    // STATE
    let students = [];
    let expenses = [];
    let currentId = null;
    let studentViewMode = 'active';

    // --- AUTH ---
    function googleLogin() {
        document.getElementById('loader').style.display = 'block';
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(err => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('login-status').innerText = err.message;
        });
    }

    function logout() { auth.signOut(); location.reload(); }

    auth.onAuthStateChanged(user => {
        document.getElementById('loader').style.display = 'none';
        if (user && user.email === ADMIN_EMAIL) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('main-content').style.display = 'block';
            loadData();
        } else if (user) {
            auth.signOut();
            alert("Access Denied!");
        } else {
            document.getElementById('login-overlay').style.display = 'flex';
        }
    });

    // --- DATA ---
    function loadData() {
        db.ref('students').on('value', (snapshot) => {
            const data = snapshot.val();
            students = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
            students.forEach(s => {
                if (!s.payments) s.payments = [];
                s.status = s.status || 'active'; 
            });
            updateDashboard();
            renderTable();
            if(!document.getElementById('trackerMonth').value) {
                const now = new Date();
                const mStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                document.getElementById('trackerMonth').value = mStr;
            }
            loadTrackerData();
        });

        db.ref('expenses').on('value', (snapshot) => {
            const data = snapshot.val();
            expenses = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
            updateDashboard();
            renderExpenses();
        });
    }

    // --- DASHBOARD ---
    function updateDashboard() {
        let activeCount = 0, dropCount = 0;
        let totalRev = 0, marketDue = 0;
        let totalExp = 0;
        
        const currentYear = new Date().getFullYear();
        document.getElementById('currentYear').innerText = currentYear;
        const monthlyStats = Array(12).fill(0); 

        students.forEach(s => {
            const f = getFinance(s);
            totalRev += f.totalPaid; // Includes Exam Fee in Revenue
            
            if(s.status === 'dropout') {
                dropCount++;
            } else {
                activeCount++;
                marketDue += f.displayDue; // Only Monthly + Adm due
            }

            s.payments.forEach(p => {
                const pDate = new Date(p.date);
                if (pDate.getFullYear() === currentYear) {
                    monthlyStats[pDate.getMonth()] += p.amount;
                }
            });
        });

        expenses.forEach(e => totalExp += e.amount);

        document.getElementById('d_active').innerText = activeCount;
        document.getElementById('d_dropout').innerText = dropCount;
        document.getElementById('d_collected').innerText = '‚Çπ' + totalRev.toLocaleString();
        document.getElementById('d_due').innerText = '‚Çπ' + marketDue.toLocaleString();
        document.getElementById('d_expense').innerText = '‚Çπ' + totalExp.toLocaleString();
        
        const profit = totalRev - totalExp;
        const pEl = document.getElementById('d_profit');
        pEl.innerText = '‚Çπ' + profit.toLocaleString();
        pEl.style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';

        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const grid = document.getElementById('yearlyStats');
        grid.innerHTML = '';
        monthlyStats.forEach((amount, index) => {
            grid.innerHTML += `
                <div class="month-box">
                    <h4>${monthNames[index]}</h4>
                    <p>‚Çπ${amount.toLocaleString()}</p>
                </div>
            `;
        });
    }

    // --- TRACKER ---
    function loadTrackerData() {
        const mInput = document.getElementById('trackerMonth').value;
        if(!mInput) return;
        const [year, month] = mInput.split('-');

        const unpaidList = document.getElementById('unpaidList');
        const paidList = document.getElementById('paidList');
        unpaidList.innerHTML = ''; paidList.innerHTML = '';
        let uCount=0, pCount=0;

        const activeStudents = students.filter(s => s.status === 'active');

        activeStudents.forEach(s => {
            const hasPaid = s.payments.some(p => {
                const d = new Date(p.date);
                return d.getFullYear() == year && (d.getMonth()+1) == month && p.type === 'Monthly Fee';
            });

            const div = document.createElement('div');
            div.className = 'tracker-item';

            if(hasPaid) {
                div.innerHTML = `<div><b>${s.name}</b><br><small>${s.batch}</small></div><span class="bg-paid">PAID</span>`;
                paidList.appendChild(div);
                pCount++;
            } else {
                const monthName = new Date(year, month-1).toLocaleString('default', { month: 'long' });
                div.innerHTML = `
                    <div><b>${s.name}</b><br><small>${s.batch}</small></div>
                    <button class="action-btn btn-wa" style="background:#25D366" onclick="sendSpecificReminder('${s.phone}','${s.name}','${monthName}')">
                        <i class="fab fa-whatsapp"></i>
                    </button>`;
                unpaidList.appendChild(div);
                uCount++;
            }
        });
        document.getElementById('unpaidCount').innerText = uCount;
        document.getElementById('paidCount').innerText = pCount;
    }

    function sendSpecificReminder(phone, name, month) {
        const text = `‚ö†Ô∏è *MONTHLY FEE REMINDER*\n--------------------------------\nüéì *TIKARKHANJI JNYCTSD*\n--------------------------------\nüë§ Student: *${name}*\nüìÖ Month: *${month}*\n\nYour monthly fee is pending. Please clear it soon.\n--------------------------------\nüôè Thank You`;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(text)}`, '_blank');
    }

    // --- ADMISSION ---
    function setDefaults() {
        const type = document.getElementById('studentType').value;
        const isOld = document.getElementById('isOldStudent').checked;
        const adm = document.getElementById('admFee');
        if(type === 'senior') {
            adm.value = isOld ? 0 : 400;
            document.getElementById('monthlyFee').value = 300;
            document.getElementById('examFee').value = 500;
            document.getElementById('duration').value = 12;
        } else {
            adm.value = isOld ? 0 : 500;
            document.getElementById('monthlyFee').value = 250;
            document.getElementById('examFee').value = 0;
            document.getElementById('duration').value = 12;
        }
        adm.disabled = isOld;
    }
    
    function toggleOldStudent() { setDefaults(); }

    document.getElementById('admForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const s = {
            status: 'active',
            type: document.getElementById('studentType').value,
            name: document.getElementById('name').value,
            batch: document.getElementById('batch').value,
            phone: document.getElementById('phone').value,
            joinDate: document.getElementById('joinDate').value,
            admFee: Number(document.getElementById('admFee').value),
            monthlyFee: Number(document.getElementById('monthlyFee').value),
            duration: Number(document.getElementById('duration').value),
            examFee: Number(document.getElementById('examFee').value),
            payments: []
        };
        db.ref('students').push(s);
        e.target.reset();
        setDefaults();
        alert("Student Added!");
        navigate('students');
    });

    // --- ACTIONS ---
    function switchStudentView(mode) {
        studentViewMode = mode;
        document.getElementById('btn-view-active').classList.toggle('active', mode === 'active');
        document.getElementById('btn-view-drop').classList.toggle('active', mode === 'dropout');
        renderTable();
    }

    function markDropout(id) {
        if(confirm("Confirm Drop-Out?")) db.ref('students/' + id).update({ status: 'dropout' });
    }

    function restoreStudent(id) {
        if(confirm("Restore to Active?")) db.ref('students/' + id).update({ status: 'active' });
    }

    function deleteStudent(id) {
        if(confirm("‚ö†Ô∏è DELETE PERMANENTLY?")) db.ref('students/' + id).remove();
    }

    document.getElementById('expForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const ex = {
            category: document.getElementById('expCat').value,
            amount: Number(document.getElementById('expAmount').value),
            note: document.getElementById('expNote').value,
            date: document.getElementById('expDate').value
        };
        db.ref('expenses').push(ex);
        document.getElementById('expAmount').value = '';
        document.getElementById('expNote').value = '';
    });

    function deleteExpense(id) {
        if(confirm("Delete expense?")) db.ref('expenses/' + id).remove();
    }

    function renderExpenses() {
        const tbody = document.getElementById('expBody');
        tbody.innerHTML = '';
        expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(ex => {
            tbody.innerHTML += `
                <tr>
                    <td>${ex.date}</td>
                    <td><b>${ex.category}</b><br><small>${ex.note}</small></td>
                    <td style="color:var(--danger);">- ‚Çπ${ex.amount}</td>
                    <td><button class="action-btn btn-del" onclick="deleteExpense('${ex.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>`;
        });
    }

    // --- FINANCE LOGIC (UPDATED: EXAM FEE HIDDEN FROM DUE) ---
    function getFinance(s) {
        let paidAdm = 0, paidMon = 0, paidExam = 0;
        
        s.payments.forEach(p => {
            if(p.type === 'Admission Fee') paidAdm += p.amount;
            else if(p.type === 'Exam Fee') paidExam += p.amount;
            else paidMon += p.amount; // Monthly
        });

        const start = new Date(s.joinDate);
        const now = new Date();
        // Post-paid logic: Months passed excluding current
        let months = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
        
        if (months < 0) months = 0; 
        if (months > s.duration) months = s.duration;

        // Due Calculation: Only Adm + Monthly (Exclude Exam)
        let dueAdm = Math.max(0, s.admFee - paidAdm);
        let dueMon = Math.max(0, (s.monthlyFee * months) - paidMon);
        
        let displayDue = dueAdm + dueMon; // This is what is shown in Red

        if(s.status === 'dropout') displayDue = 0;

        return { 
            displayDue, 
            paidAdm, paidMon, paidExam, 
            totalPaid: paidAdm + paidMon + paidExam 
        };
    }

    // --- RENDER TABLE (UPDATED) ---
    function renderTable() {
        const tbody = document.getElementById('tbody');
        const search = document.getElementById('search').value.toLowerCase();
        tbody.innerHTML = '';

        const list = students.filter(s => s.status === studentViewMode);
        
        if(list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:20px; color:#9ca3af;">No records found.</td></tr>`;
            return;
        }

        list.filter(s => s.name.toLowerCase().includes(search)).reverse().forEach(s => {
            const f = getFinance(s);
            const badge = s.type==='senior' ? 'Senior' : 'Junior';
            const color = s.type==='senior' ? '#f3e8ff' : '#e0f2fe';
            const textC = s.type==='senior' ? '#7c3aed' : '#0284c7';

            let buttons = '';
            // WhatsApp Msg excludes Exam Fee due
            const reminderMsg = `‚ö†Ô∏è *FEE REMINDER*\n--------------------------------\nüéì *TIKARKHANJI JNYCTSD*\n--------------------------------\nüë§ Student: *${s.name}*\nüìÇ Batch: ${s.batch}\n\nüìâ *Pending Due: ‚Çπ${f.displayDue}*\n\nYour fees are overdue. Please clear them soon.\n--------------------------------\nüôè Thank You`;

            if(studentViewMode === 'active') {
                buttons = `
                    <button class="action-btn btn-pay" onclick="openPay('${s.id}')" title="Pay"><i class="fas fa-plus"></i></button>
                    <a href="https://wa.me/${s.phone}?text=${encodeURIComponent(reminderMsg)}" target="_blank" class="action-btn btn-wa" title="Send Reminder"><i class="fab fa-whatsapp"></i></a>
                    <button class="action-btn btn-drop" onclick="markDropout('${s.id}')" title="Dropout"><i class="fas fa-user-slash"></i></button>
                    <button class="action-btn btn-del" onclick="deleteStudent('${s.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                `;
            } else {
                buttons = `
                    <button class="action-btn btn-restore" onclick="restoreStudent('${s.id}')" title="Restore"><i class="fas fa-undo"></i></button>
                    <button class="action-btn btn-del" onclick="deleteStudent('${s.id}')" title="Permanent Delete"><i class="fas fa-trash"></i></button>
                `;
            }

            tbody.innerHTML += `
                <tr>
                    <td>
                        <b>${s.name}</b> <span style="background:${color}; color:${textC}; padding:2px 6px; border-radius:4px; font-size:0.75rem;">${badge}</span>
                        <br><i class="fas fa-phone-alt" style="font-size:0.75rem; color:#6b7280; margin-right:4px;"></i><span style="font-weight:600; color:#4b5563;">${s.phone}</span>
                        <br><small style="color:#6b7280">${s.batch}</small>
                    </td>
                    <td>
                        <div style="font-size:0.8rem; line-height:1.4;">
                            <span style="color:#2563eb">Adm Paid: ‚Çπ${f.paidAdm}</span><br>
                            <span style="color:#10b981">Mon Paid: ‚Çπ${f.paidMon}</span><br>
                            <span style="color:#8b5cf6">Exam Paid: ‚Çπ${f.paidExam}</span>
                        </div>
                    </td>
                    <td>
                        <div style="font-weight:700; color:${f.displayDue > 0 ? 'var(--danger)' : 'var(--success)'}; margin-bottom:5px;">
                            ${f.displayDue > 0 ? 'Due: ‚Çπ'+f.displayDue : 'Paid'}
                        </div>
                        ${buttons}
                    </td>
                </tr>`;
        });
    }

    // --- PAYMENTS ---
    function openPay(id) { currentId = id; document.getElementById('modal').style.display='flex'; }
    function submitPay() {
        const amt = Number(document.getElementById('payAmount').value);
        const type = document.getElementById('payType').value;
        if(amt>0 && currentId) {
            const s = students.find(x=>x.id===currentId);
            const newPay = { date: new Date().toISOString(), amount: amt, type: type };
            db.ref('students/'+currentId+'/payments').set([...(s.payments||[]), newPay]);
            document.getElementById('modal').style.display='none';
            document.getElementById('payAmount').value='';
            
            const dateStr = new Date().toLocaleDateString('en-IN');
            const receiptMsg = `üßæ *PAYMENT RECEIPT*\n--------------------------------\nüéì *TIKARKHANJI JNYCTSD*\n--------------------------------\nüë§ Name: *${s.name}*\nüìÇ Batch: ${s.batch}\nüìÖ Date: ${dateStr}\n\nüí∞ *Received: ‚Çπ${amt}*\nüìå Type: ${type}\n\n‚úÖ *Status: Paid*\n--------------------------------\nThank you for your payment! üôè`;
            window.open(`https://wa.me/${s.phone}?text=${encodeURIComponent(receiptMsg)}`, '_blank');
        }
    }

    function navigate(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const map = {'dashboard':'btn-dash', 'monthTracker':'btn-track', 'admission':'btn-adm', 'students':'btn-std', 'expenses':'btn-exp'};
        if(map[id]) document.getElementById(map[id]).classList.add('active');
        document.querySelector('.main').scrollTop = 0;
    }

    document.getElementById('joinDate').valueAsDate = new Date();
    document.getElementById('expDate').valueAsDate = new Date();
    setDefaults();
</script>
</body>
</html>
